<?php

/**
 * @file
 * Primary module hooks for NutriPal module.
 *
 * @DCG
 * This file is no longer required in Drupal 8.
 * @see https://www.drupal.org/node/2217931
 
 /**
 * Implements nutripal_page_attachements_alter().
 *
 *@param array &$attachements
 */
function nutripal_page_attachments_alter(array &$page) {
    $userRoute = \Drupal::routeMatch()->getCurrentRouteMatch()->getRouteName();
    $user = \Drupal::routeMatch()->getParameter('user');

    if ($userRoute == 'nutripal.user_progression') {
        $page['#attached']['library'][] = 'nutripal/user-progression';
        $idUser = $user->id();
        $registeredDate = $user->getCreatedTime();
        $weight   = isset($user->field_weight)        ? $user->field_weight->getString()        : 0;
        $weight_t = isset($user->field_target_weight) ? $user->field_target_weight->getString() : 0;

        $progression = \Drupal::database()->select('nutripal_user_progression')
                ->fields('nutripal_user_progression', ['uid', 'weight', 'date'])
                ->condition('uid', $idUser, '=')
                ->execute();
        
        $rows = [];

        $date = $registeredDate;
        if($weight_t == 0) {
            $rows[] = [$date, (int) $weight];
        } else {
            $rows[] = [$date, (int) $weight, (int) $weight_t];
        }
        
        if ($progression) {
            foreach ($progression as $value) {
                $date = $value->date;
                $weight = $value->weight;
                if($weight_t == 0) {
                    $rows[] = [$date, (int) $weight];
                } else {
                    $rows[] = [$date, (int) $weight, (int) $weight_t];
                }
            }
        }
       
        $page['#attached']['drupalSettings']['nutripal']['values']['progression'] = $rows;
    }
}
